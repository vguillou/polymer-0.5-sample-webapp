<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">

<polymer-element name="user-service" attributes="users">
  <template>
    <style>
    :host {
      display: none;
    }
    </style>
	
    <core-ajax id="ajaxUsers"
	  url="http://api.randomuser.me/0.4/?results=100"
      on-core-response="{{usersLoaded}}"
	  on-core-error="{{usersError}}"
      handleAs="json">
    </core-ajax>
	
	<core-ajax id="ajaxDetails"
	  url="http://api.randomuser.me/0.4/?seed={{seed}}"
      on-core-response="{{detailsLoaded}}"
	  on-core-error="{{detailsError}}"
      handleAs="json">
    </core-ajax>
	
  </template>
  <script>
  (function() {
    // this variable is shared by all instances of the service
    var users_ = [];
	var colors_ = ['#5C6BC0','#E91E63','#9C27B0','#673AB7','#3F51B5','#2196F3','#03A9F4','#00BCD4','#009688','#4CAF50','#8BC34A','#CDDC39','#FFEB3B','#FFC107','#FF9800','#FF5722','#795548','#795548','#607D8B'];

    Polymer('user-service', {
	  seed: null,
	  
	  /** 
       * Load all the user (random results from randomuser.me). 
       * 
       * @method fetchUsers
       */
      fetchUsers: function() {
	    this.$.ajaxUsers.go();
      },
	  
	  /** 
       * Load the details of a given user.
       * 
       * @method fetchUserDetails
       * @param seed {String} Unique seed of the user to retrieve.
       */
      fetchUserDetails: function(seed) {
        this.seed = seed;
		console.log("seed:", seed);
		this.$.ajaxDetails.go();
      },
	  
      usersLoaded: function(e) {
		if (this.$.ajaxUsers.response) {
			//users_ = this.$.ajaxUsers.response.results.slice(0);
			
			// Trimming down user infos to a minimum for the purpose of this sample app
			var randColor = null;
			this.$.ajaxUsers.response.results.forEach(
				function addUser(u) {
					randColor = colors_[Math.floor(Math.random() * colors_.length)];
					users_.push({id: u.seed,
						username: u.user.username,
						picture: u.user.picture,
						color: randColor,
						name: {title: u.user.name.title, first: u.user.name.first, last: u.user.name.last}});
				}
			);
			this.fire('users-loaded', {result: users_}, this, false);
		}
      },
	  
	  usersError: function(e) {
		this.fire('users-error', {srcEvent: e}, this, false);
      },
	  
      detailsLoaded: function(e) {
		if (this.$.ajaxDetails.response) {
			details = this.$.ajaxDetails.response.results[0].user;
			this.fire('details-loaded', {result: details}, this, false);
		}
      },
	  
	  detailsError: function(e) {
		this.fire('details-error', {srcEvent: e}, this, false);
      }
    });
  })();
  </script>
</polymer-element>
