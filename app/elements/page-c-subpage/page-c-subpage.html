<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/core-scroll-header-panel/core-scroll-header-panel.html">
<link rel="import" href="../../../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/activable-mixin/activable-mixin.html">
<link rel="import" href="../../../bower_components/core-image/core-image.html">
<link rel="import" href="../../../bower_components/core-icon/core-icon.html">
<link rel="import" href="../../../bower_components/core-animated-pages/transitions/hero-transition.html">
<link rel="import" href="../../../bower_components/core-animated-pages/transitions/cross-fade.html">
<link rel="import" href="../../services/user-service.html">
<link rel="import" href="../sample-content/sample-content.html">

<polymer-element name="page-c-subpage" attributes="narrow params user transitionTo">
	<template>
		<link rel="stylesheet" href="page-c-subpage.css">
		
		<user-service id="service" on-details-loaded="{{detailsLoaded}}" on-details-error="{{detailsError}}"></user-service>
			<!-- Only for the hero transition; to be hidden when the transition ends -->
			<div id="herodiv" class="tall-header" hero-id="userImg" hero?="{{(parentElement.selected===transitionTo || parentElement.lastSelected===transitionTo) && user}}" cross-fade-delayed?="{{(parentElement.selected!=transitionTo && parentElement.lastSelected!=transitionTo) || !user}}"></div>
			
			<!-- Page content -->
			<core-scroll-header-panel id="headerpanel" condenses on-core-header-transform="{{transformHeader}}" fit cross-fade-delayed>

				<core-toolbar id="toolbar" class="tall tall-header" style="background-color: transparent;" not-selectable>
					<paper-icon-button icon="arrow-back" on-tap="{{onGoBack}}"></paper-icon-button>
					<div class="bottom indent title" flex>{{user.name.title | toUpperCase}} {{user.name.first | toUpperCase}} {{user.name.last | toUpperCase}}</div>
				</core-toolbar>

				<div class="content">
					<!-- Phone -->
			        <div class="group">
			          <div class="item">
			            <core-icon icon="perm-phone-msg"></core-icon>
			            <div class="double-line-1">{{user.phone ? user.phone : '...'}}</div>
			            <div class="double-line-2">Home</div>
			          </div>
			          <div class="item">
			            <div class="double-line-1">{{user.cell ? user.cell : '...'}}</div>
			            <div class="double-line-2">Cell</div>
			          </div>
			        </div>

			        <!-- Email -->
			        <div class="group">
			          <div class="item">
			          	<core-icon icon="mail"></core-icon>
			            <div class="double-line-1">{{user.email ? user.email : '...'}}</div>
			            <div class="double-line-2">Personal</div>
			          </div>
			        </div>

			        <!-- Address -->
			        <div class="group">
			          <div class="item">
			            <core-icon icon="room"></core-icon>
			            <div class="double-line-1">{{user.location ? user.location.street : '...'}}</div>
			            <div class="double-line-1">{{user.location ? user.location.city : '...'}} {{user.location.state}} {{user.location.zip}}</div>
			            <div class="double-line-2">Home</div>
			          </div>
			        </div>

					<sample-content size="5" ></sample-content>
				</div>
			</core-scroll-header-panel>

		</div>
	</template>
	<script>
		Polymer('page-c-subpage', Polymer.mixin({
			narrow: false,

			/**
			 * The route parameters.
			 */
			params: null,
			
			/**
			 * The user to display.
			 */
			user: null,

			/**
			 * The identifier of the page to transition to when a user is clicked.
			 */
			transitionTo: -1,

			/**
			 * Color of the page's header.
			 */
			get headerColor() {
				return this.user && this.user.color ? this.user.color : window.defaultColor;
			},

			herodivHidden: false,

			attributeChanged: function(attrName, oldVal, newVal) {
				// Necessary for ActivableMixin
				this.activableAttributeChangedHandler(attrName, oldVal, newVal);
			},
			userChanged: function(oldVal, newVal) {
				this.changeHeaderImage(newVal ? newVal.picture : null);
				this.changeCondensedHeaderColor(this.headerColor);
			},
			detached: function() {
				// Necessary for ActivableMixin
				this.activableDetachedHandler();
			},
			willActivate: function() {
				// Before even displying the page, make sure the scroller is set to top
				this.$.headerpanel.scroller.scrollTop = 0;

				// Show the hero-transition's target
				this.$.herodiv.style.visibility = 'visible';
				this.herodivHidden = false;
			},
			activated: function() {
				// Get the details from the object's ID
				this.$.service.fetchUserDetails(this.params.id);

				// Hide the now useless hero-transition's target
				this.async(function() {
					this.$.herodiv.style.visibility = 'hidden';
					this.herodivHidden = true;
				}, null, 300);

				// Request to change the theme color if possible
				this.requestThemeColorChange();
			},
			deactivated: function() {
				// Reset the page once the page is not displayed anymore
				this.user = null;
			},
			detailsLoaded: function(e) {
				var userDetails = e.detail.result;
				// Needs to change theme color if not done already
				var needsThemeColorChange = !(this.user && this.user.color);

				if (userDetails) {
					// Once the details are availlable, replace the incomplete object with
					// the complete one. Small trick to maintain the generated color.
					userDetails.color = this.user ? this.user.color : userDetails.color;
					this.user = userDetails;
					if (needsThemeColorChange) {
						this.requestThemeColorChange();
					}
				} else {
					window.location = './404.html';
				}
			},
			detailsError: function(e) {
				// Show the error that happened while loading the details
				console.log('page-c-subpage.detailsError', e);
			},
			toUpperCase: function(value) {
			    // Filter to display a string in upper case only
				if (value) {
					return value.toUpperCase();
				}
			},
			onGoBack: function() {
				this.fire('navigate', {route: 'page-c', params: null}, this, false);
			},
			changeHeaderImage: function(newValue) {
		  		// Background for toolbar when it is at its full size
		  		var headerStyle = this.$.headerpanel.shadowRoot.querySelector('#headerBg').style;
		  		headerStyle.backgroundImage = this.$.herodiv.style.backgroundImage = (newValue ? 'url(' + newValue + ')' : 'none');
		  	},
		    changeCondensedHeaderColor: function(newValue) {
		    	// Background for the toolbar when it is condensed
		  		var headerStyle = this.$.headerpanel.shadowRoot.querySelector('#condensedHeaderBg').style;
		  		headerStyle.backgroundColor = this.$.herodiv.style.backgroundColor = (newValue ? newValue : window.defaultColor);
		  	},
			transformHeader: function(e) {
				// Hide the herodiv if it is not already
				if (!this.herodivHidden || this.$.headerpanel.scroller.scrollTop > 0) {
					this.$.herodiv.style.visibility = 'hidden';
					this.herodivHidden = true;
				}

				// Calculating the scale of the title
				var titleStyle = this.shadowRoot.querySelector('.title').style;
				var d = e.detail;
				var m = d.height - d.condensedHeight;
				var scale = Math.max(0.75, (m - d.y) / (m / 0.25)  + 0.75);
				titleStyle.transform = titleStyle.webkitTransform =
					'scale(' + scale + ') translateZ(0)';
			},
			requestThemeColorChange: function() {
				if (this.user && this.user.color) {
					this.fire('change-theme-color', {color: this.user.color}, this, false);
				}
			}
		}, Polymer.ActivableMixin));
	</script>
</polymer-element>