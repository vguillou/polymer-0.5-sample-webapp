<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../../../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/activable-mixin/activable-mixin.html">
<link rel="import" href="../../../bower_components/core-list/core-list.html">
<link rel="import" href="../../../bower_components/core-image/core-image.html">
<link rel="import" href="../../../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../../../bower_components/core-animated-pages/transitions/hero-transition.html">
<link rel="import" href="../../../bower_components/core-animated-pages/transitions/cross-fade.html">
<link rel="import" href="../../services/user-service.html">

<polymer-element name="page-c" attributes="narrow selectedUser transitionTo">
	<template>
		<link rel="stylesheet" href="page-c.css">
		
		<user-service id="service" on-users-loaded="{{usersLoaded}}" on-users-error="{{usersError}}"></user-service>
		
		<core-header-panel id="headerpanel" mode="waterfall" fit>
			<core-toolbar not-selectable cross-fade>
				<paper-icon-button icon="menu" on-tap="{{togglePanel}}" hidden?="{{!narrow}}"></paper-icon-button>
				<span flex>Page C</span>
			</core-toolbar>
			<div class="content" fit>
				
				<core-list id="list" data="{{users}}" fit cross-fade>
					<template>
						<div>
						<a href="{{model ? urlFor('page-c-subpage', {id: model.id}) : '#!'}}" on-click="{{userSelected}}" data-userid="{{model.id}}" hero-p?="{{model.id===selectedUser.id}}">
							<paper-ripple fit></paper-ripple>
							<div class="row" layout horizontal center hero-p?="{{model.id===selectedUser.id}}">
								<core-image class="round" src="{{model.picture}}" preload sizing="cover" _style="background-color: {{model.color}};" hero-id="userImg" hero?="{{model.id===selectedUser.id}}"></core-image>
								<p flex>{{model.name.title}} {{model.name.first}} {{model.name.last}}</p>
								<p>{{model.username}}</p>
							</div>
						</a>
					</div>
					</template>
				</core-list>
				
			</div>
		</core-header-panel>
	</template>
	<script>
		Polymer('page-c', Polymer.mixin({
			narrow: false,
			
			/**
			 * The selected user to be displayed.
			 */
			selectedUser: null,

			/**
			 * The identifier of the page to transition to when a user is clicked.
			 */
			transitionTo: -1,

			attributeChanged: function(attrName, oldVal, newVal) {
                //console.log(attrName, oldVal, newVal);

				// Necessary for ActivableMixin
				this.activableAttributeChangedHandler(attrName, oldVal, newVal);
			},
			detached: function() {
				// Necessary for ActivableMixin
				this.activableDetachedHandler();
			},
			willActivate: function() {
				// Load the users
				if (!this.users) {
					this.$.service.fetchUsers();
				}

				// Reset theme color
				this.async(function() {
					this.fire('change-theme-color', {color: window.defaultColor}, this, false);
				}, null, 100);
			},
			usersLoaded: function(e) {
				// Grab the loaded users
				this.users = e.detail.result;
			},
			usersError: function(e) {
				// Show the error that happened while loading the users
				console.log('page-c.usersError', e);
			},
			userSelected: function(e, detail, sender) {
				// When a user is tapped, select it
				var userid = sender.dataset.userid;
				this.users.some(function(u) {
					if (u.id === userid) {
						this.selectedUser = u;
						return true;
					}
					return false;
				}.bind(this));
			},
			togglePanel: function(e) {
				// Request the drawer panel
				this.fire('toggle-panel', {srcEvent: e}, this, false);
			}
		}, Polymer.ActivableMixin));
	</script>
</polymer-element>