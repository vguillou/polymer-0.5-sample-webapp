<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../../../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/activable-mixin/activable-mixin.html">
<link rel="import" href="../../../bower_components/core-image/core-image.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/core-animated-pages/transitions/cross-fade.html">
<link rel="import" href="../sample-content/sample-content.html">

<polymer-element name="page-a">
	<template>
		<link rel="stylesheet" href="page-a.css">
		
		<core-header-panel id="headerpanel" mode="seamed" on-scroll="{{scroll}}" fit cross-fade>
			
			<div class="content" fit>
				<core-image id="headerimage" src="../../images/logo.svg" preload fade sizing="contain" _style="background-color: {{themecolor}};"></core-image>

				<sample-content size="10" cross-fade-delayed></sample-content>
			</div>

			<core-toolbar id="toolbar" not-selectable>
				<paper-icon-button icon="menu" on-tap="{{togglePanel}}" hidden?="{{!narrow}}"></paper-icon-button>
				<span id="title" class="toolbarTitle" flex>Page A</span>
				<paper-icon-button icon="account-circle" title="Do something" on-tap="{{doSomething}}"></paper-icon-button>
				<paper-icon-button id="fullscreenBtn" icon="{{fullscreen ? 'fullscreen-exit' : 'fullscreen'}}" title="{{(fullscreen ? 'Exit' : 'Go') + ' full screen'}}" onclick="toggleFullscreen()"></paper-icon-button>
			</core-toolbar>
		</core-header-panel>
	</template>
	<script>
		/*exported toggleFullscreen */

		// Full screen API
		function isFullscreenEnabled() {
			return (document.fullscreenEnabled || 
			    document.webkitFullscreenEnabled || 
			    document.mozFullScreenEnabled ||
			    document.msFullscreenEnabled) ? true : false;
		}
		function isFullscreenToggled() {
			return (document.fullscreenElement ||
			    document.webkitFullscreenElement ||
			    document.mozFullScreenElement ||
			    document.msFullscreenElement) ? true : false;
		}
		function toggleFullscreen() {
			if (isFullscreenEnabled()) {
				if (!isFullscreenToggled()) {
					var d = document.documentElement;
					if (d.requestFullscreen) {
					    d.requestFullscreen();
					} else if (d.webkitRequestFullscreen) {
					    d.webkitRequestFullscreen();
					} else if (d.mozRequestFullScreen) {
					    d.mozRequestFullScreen();
					} else if (d.msRequestFullscreen) {
					    d.msRequestFullscreen();
					}
				} else {
					if (document.exitFullscreen) {
					    document.exitFullscreen();
					} else if (document.webkitExitFullscreen) {
					    document.webkitExitFullscreen();
					} else if (document.mozCancelFullScreen) {
					    document.mozCancelFullScreen();
					} else if (document.msExitFullscreen) {
					    document.msExitFullscreen();
					}
				}
			}
		}

		// Element
		Polymer('page-a', Polymer.mixin({
			publish: {
				narrow: false,
				themecolor: window.defaultColor,
			},

			/**
			 * The current opacity of the page's header image.
			 */
			alpha: 0,

			/**
			 * Tracks if the web-app is displayed in fullscreen mode.
			 */
			fullscreen: false,

			attributeChanged: function(attrName, oldVal, newVal) {
				this.activableAttributeChangedHandler(attrName, oldVal, newVal);
			},
			attached: function() {
				// Add fullscreen change listener
				if (isFullscreenEnabled()) {
					document.addEventListener('fullscreenchange', this.changeFullscreen.bind(this));
					document.addEventListener('webkitfullscreenchange', this.changeFullscreen.bind(this));
					document.addEventListener('mozfullscreenchange', this.changeFullscreen.bind(this));
					document.addEventListener('MSFullscreenChange', this.changeFullscreen.bind(this));
				} else {
					this.$.fullscreenBtn.style.display = 'none';
				}
				this.changeFullscreen();
			},
			detached: function() {
				this.activableDetachedHandler();

				if (isFullscreenEnabled()) {
					document.removeEventListener('fullscreenchange', this.changeFullscreen);
					document.removeEventListener('webkitfullscreenchange', this.changeFullscreen);
					document.removeEventListener('mozfullscreenchange', this.changeFullscreen);
					document.removeEventListener('MSFullscreenChange', this.changeFullscreen);
				}
			},
			willActivate: function() {
				console.log('page-a.willActivate => Do your page init thingy here');
				this.scroll();
			},
			activated: function() {
				console.log('page-a.activated');
			},
			willDeactivate: function() {
				console.log('page-a.willDeactivate');
			},
			deactivated: function() {
				console.log('page-a.deactivated => Do your page exit thingy here');
			},
			togglePanel: function(e) {
				this.fire('toggle-panel', {srcEvent: e}, this, false);
			},
			doSomething: function() {
				console.log('Do something');
			},
			changeFullscreen: function() {
				this.fullscreen = isFullscreenToggled();
			},
			scroll: function() {
				var headerHeight = this.$.headerimage.offsetHeight;
				var scrollTop = this.$.headerpanel.scroller.scrollTop;
				var newAlpha = 1 - Math.max(0, (headerHeight - scrollTop) / headerHeight);
				if (newAlpha !== this.alpha) {
					this.alpha = newAlpha;
					var matches = this.themecolor.match(/#([\da-f]{2})([\da-f]{2})([\da-f]{2})/i);
					var rgba = 'rgba(' + matches.slice(1).map(function(m) {
						return parseInt(m, 16);
					}).concat(this.alpha) + ')';
					this.$.toolbar.style.backgroundColor = rgba;
					this.$.title.style.opacity = this.alpha;
				}
			}
		}, Polymer.ActivableMixin));
	</script>
</polymer-element>